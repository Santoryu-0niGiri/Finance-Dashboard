<mat-toolbar>
  <span>Finance Dashboard</span>
  <span class="spacer"></span>

  <button mat-icon-button (click)="theme.toggle()" aria-label="Toggle theme">
    <mat-icon>{{ theme.isLight() ? 'light_mode' : 'dark_mode' }}</mat-icon>
  </button>

  <span *ngIf="auth.user()" class="user-info">
    <mat-icon>account_circle</mat-icon>
    {{ auth.user()?.name }}
  </span>

  <button mat-button (click)="logout()">Logout</button>
</mat-toolbar>

<div class="dashboard-container overview-layout">
  <!-- left/main column -->
  <div class="main-column">
    <mat-card class="filters-card mt-3">
      <mat-card-title>Filters</mat-card-title>
      <mat-card-content>
        <mat-button-toggle-group name="filter" [(ngModel)]="selectedFilter" (change)="onFilterChange()">
          <mat-button-toggle value="week">This Week</mat-button-toggle>
        <mat-button-toggle value="month">This Month</mat-button-toggle>
          <mat-button-toggle value="year">This Year</mat-button-toggle>
          <mat-button-toggle value="all">All</mat-button-toggle>
        </mat-button-toggle-group>

        <button mat-stroked-button color="primary" (click)="openChartsModal()" class="full-charts-btn">
          View Full Charts
        </button>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card mt-3">
      <mat-card-title>Summary</mat-card-title>
      <mat-card-content>
        <p><strong>Total Income:</strong> {{ income() | currency:'PHP' }}</p>
        <p><strong>Total Expenses:</strong> {{ expenses() | currency:'PHP' }}</p>
        <p><strong>Balance:</strong> {{ balance() | currency:'PHP' }}</p>

        <hr />

        <div class="goals-summary">
          <p>
            <strong>Goals ({{ goalsCount() }})</strong>
            &nbsp;—&nbsp;
            <small>Total saved:</small> {{ totalGoalsSaved() | currency:'PHP' }}
            <span class="muted">/</span>
            <small>Total target:</small> {{ totalGoalsTarget() | currency:'PHP' }}
            <span *ngIf="totalGoalsTarget() > 0" class="muted">({{ goalsProgressPct() }}%)</span>
          </p>

          <div *ngIf="goalsList().length > 0; else noGoals">
            <div *ngFor="let g of goalsList() | slice:0:3" class="goal-row">
              <div class="goal-meta">
                <div class="goal-title">{{ g.title }}</div>
                <div class="goal-deadline">Deadline:
                  <small>{{ g.targetDate ? (g.targetDate | date:'mediumDate') : '—' }}</small>
                </div>
              </div>

              <div class="goal-progress">
                <div class="amounts">
                  <small>{{ (g.currentAmount || 0) | currency:'PHP' }}</small>
                  <span class="slash">/</span>
                  <small>{{ g.targetAmount | currency:'PHP' }}</small>
                </div>

                <mat-progress-bar mode="determinate"
                  [value]="((g.currentAmount || 0) / (g.targetAmount || 1)) * 100">
                </mat-progress-bar>
              </div>
            </div>

            <div *ngIf="goalsList().length > 3" class="view-all">
              <a (click)="goToGoals()" class="clickable">View all goals ({{ goalsCount() }})</a>
            </div>
          </div>

          <ng-template #noGoals>
            <div>No goals yet.</div>
          </ng-template>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Charts card -->
    <mat-card class="mt-3">
      <mat-card-title>Insights</mat-card-title>
      <mat-card-content>
        <app-overview-charts></app-overview-charts>
      </mat-card-content>
    </mat-card>

    <!-- Transactions Table -->
    <mat-card class="mt-3 transactions-card">
      <mat-card-title>
        Recent Transactions
        <span class="spacer"></span>
        <button mat-button color="primary" (click)="goToTransactions()">View All</button>
      </mat-card-title>
      <mat-card-content>
        <table mat-table [dataSource]="store.transactions()" class="mat-elevation-z2 full-width">

          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let element">{{ element.date | date:'shortDate' }}</td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>Category</th>
            <td mat-cell *matCellDef="let element">{{ getCategoryLabel(element) }}</td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let element">{{ element.type }}</td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Amount</th>
            <td mat-cell *matCellDef="let element">{{ element.amount | currency:'PHP' }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <!-- Goals -->
    <mat-card class="mt-3 goals-card">
      <mat-card-title>
        Goals
        <span class="spacer"></span>
        <button mat-button color="primary" (click)="goToGoals()">View All</button>
      </mat-card-title>
      <mat-card-content>
        <div *ngFor="let g of store.goals()" class="goal-item">
          <p><strong>{{ g.title }}</strong> — {{ g.currentAmount | currency:'PHP' }} / {{ g.targetAmount |
            currency:'PHP'
            }}</p>
          <mat-progress-bar mode="determinate" [value]="(g.currentAmount / g.targetAmount) * 100"></mat-progress-bar>
        </div>
        <div *ngIf="store.goals().length === 0">No goals yet.</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- sidebar -->
  <aside class="sidebar">
    <mat-card>
      <mat-card-title>Calendar</mat-card-title>
      <mat-card-content>
        <app-calendar-dashboard></app-calendar-dashboard>
      </mat-card-content>
    </mat-card>
  </aside>
</div>
