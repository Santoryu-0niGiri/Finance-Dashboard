<mat-toolbar>
  <span>Finance Dashboard</span>
  <span class="spacer"></span>

  <button mat-icon-button (click)="theme.toggle()" aria-label="Toggle theme">
    <mat-icon>{{ theme.isLight() ? 'light_mode' : 'dark_mode' }}</mat-icon>
  </button>

  @if (auth.user()) {
    <span class="user-info">
      <mat-icon>account_circle</mat-icon>
      {{ auth.user()?.name }}
    </span>
  }

  <button mat-button (click)="logout()">Logout</button>
</mat-toolbar>

<div class="dashboard-container overview-layout">
  <!-- left/main column -->
  <div class="main-column">
    <mat-card class="filters-card mt-3">
      <mat-card-title>Filters</mat-card-title>
      <mat-card-content>
        <mat-button-toggle-group name="filter" [(ngModel)]="selectedFilter" (change)="onFilterChange()">
          <mat-button-toggle value="week">This Week</mat-button-toggle>
          <mat-button-toggle value="month">This Month</mat-button-toggle>
          <mat-button-toggle value="year">This Year</mat-button-toggle>
          <mat-button-toggle value="all">All</mat-button-toggle>
        </mat-button-toggle-group>

        <button mat-stroked-button color="primary" (click)="openChartsModal()" class="full-charts-btn">
          View Full Charts
        </button>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card mt-3">
      <mat-card-title>Financial Summary</mat-card-title>
      <mat-card-content>
        <!-- Summary Stats Cards -->
        <div class="summary-stats">
          <div class="stat-card income">
            <div class="stat-icon">
              <mat-icon>trending_up</mat-icon>
            </div>
            <div class="stat-content">
              <div class="stat-label">Total Income</div>
              <div class="stat-value">{{ income() | currency:'PHP' }}</div>
            </div>
          </div>

          <div class="stat-card expense">
            <div class="stat-icon">
              <mat-icon>trending_down</mat-icon>
            </div>
            <div class="stat-content">
              <div class="stat-label">Total Expenses</div>
              <div class="stat-value">{{ expenses() | currency:'PHP' }}</div>
            </div>
          </div>

          <div class="stat-card balance" [class.positive]="balance() >= 0" [class.negative]="balance() < 0">
            <div class="stat-icon">
              <mat-icon>{{ balance() >= 0 ? 'account_balance_wallet' : 'money_off' }}</mat-icon>
            </div>
            <div class="stat-content">
              <div class="stat-label">Net Balance</div>
              <div class="stat-value">{{ balance() | currency:'PHP' }}</div>
            </div>
          </div>
        </div>

        <hr />

        <!-- Goals Overview -->
        <div class="goals-overview">
          <div class="goals-header">
            <div class="goals-title">
              <mat-icon>flag</mat-icon>
              <span>Goals Overview</span>
              <div class="goals-count">{{ goalsCount() }}</div>
            </div>
            <div class="goals-summary-stats">
              <div class="summary-item">
                <span class="label">Saved</span>
                <span class="value saved">{{ totalGoalsSaved() | currency:'PHP' }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Target</span>
                <span class="value target">{{ totalGoalsTarget() | currency:'PHP' }}</span>
              </div>
              @if (totalGoalsTarget() > 0) {
                <div class="summary-item">
                  <span class="label">Progress</span>
                  <span class="value progress">{{ goalsProgressPct() }}%</span>
                </div>
              }
            </div>
          </div>

          @if (goalsList().length > 0) {
            <div class="goals-list">
              @for (g of goalsList() | slice:0:3; track g) {
                <div class="goal-card">
                  <div class="goal-header">
                    <div class="goal-info">
                      <div class="goal-name">{{ g.title }}</div>
                      @if (g.targetDate) {
                        <div class="goal-deadline">
                          <mat-icon>schedule</mat-icon>
                          <span>{{ g.targetDate | date:'mediumDate' }}</span>
                        </div>
                      }
                    </div>
                    <div class="goal-amount">
                      <span class="current">{{ (g.currentAmount || 0) | currency:'PHP' }}</span>
                      <span class="separator">/</span>
                      <span class="target">{{ g.targetAmount | currency:'PHP' }}</span>
                    </div>
                  </div>
                  <div class="goal-progress-section">
                    <div class="progress-info">
                      <span class="progress-label">Progress</span>
                      <span class="progress-percentage">{{ ((g.currentAmount || 0) / (g.targetAmount || 1) * 100) | number:'1.0-1' }}%</span>
                    </div>
                    <div class="progress-bar-container">
                      <mat-progress-bar
                        mode="determinate"
                        [value]="((g.currentAmount || 0) / (g.targetAmount || 1)) * 100"
                        class="modern-progress-bar">
                      </mat-progress-bar>
                    </div>
                  </div>
                </div>
              }
              @if (goalsList().length > 3) {
                <div class="view-all-goals">
                  <button mat-stroked-button (click)="goToGoals()" class="view-all-btn">
                    <mat-icon>visibility</mat-icon>
                    <span>View all {{ goalsCount() }} goals</span>
                  </button>
                </div>
              }
            </div>
          } @else {
            <div class="empty-goals">
              <div class="empty-icon">
                <mat-icon>flag_off</mat-icon>
              </div>
              <div class="empty-text">
                <h4>No Goals Yet</h4>
                <p>Start setting financial goals to track your progress</p>
                <button mat-raised-button color="primary" (click)="goToGoals()">
                  <mat-icon>add</mat-icon>
                  Create Goal
                </button>
              </div>
            </div>
          }

        </div>
      </mat-card-content>
    </mat-card>

    <!-- Charts card -->
    <mat-card class="mt-3">
      <mat-card-title>Insights</mat-card-title>
      <mat-card-content>
        <app-overview-charts></app-overview-charts>
      </mat-card-content>
    </mat-card>

    <!-- Transactions Table -->
    <mat-card class="mt-3 transactions-card">
      <mat-card-title>
        Recent Transactions
        <span class="spacer"></span>
        <button mat-button color="primary" (click)="goToTransactions()">View All</button>
      </mat-card-title>
      <mat-card-content>
        <table mat-table [dataSource]="store.transactions()" class="mat-elevation-z2 full-width">

          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let element">{{ element.date | date:'shortDate' }}</td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>Category</th>
            <td mat-cell *matCellDef="let element">{{ getCategoryLabel(element) }}</td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let element">{{ element.type }}</td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Amount</th>
            <td mat-cell *matCellDef="let element">{{ element.amount | currency:'PHP' }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <!-- Goals -->
    <mat-card class="mt-3 goals-card">
      <mat-card-title>
        Goals
        <span class="spacer"></span>
        <button mat-button color="primary" (click)="goToGoals()">View All</button>
      </mat-card-title>
      <mat-card-content>
        @for (g of store.goals(); track g) {
          <div class="goal-item">
            <p><strong>{{ g.title }}</strong> â€” {{ g.currentAmount | currency:'PHP' }} / {{ g.targetAmount |
            currency:'PHP'
          }}</p>
          <mat-progress-bar mode="determinate" [value]="(g.currentAmount / g.targetAmount) * 100"></mat-progress-bar>
        </div>
      }
      @if (store.goals().length === 0) {
        <div>No goals yet.</div>
      }
    </mat-card-content>
  </mat-card>
</div>

<!-- sidebar -->
<aside class="sidebar">
  <mat-card>
    <mat-card-title>Calendar</mat-card-title>
    <mat-card-content>
      <app-calendar-dashboard></app-calendar-dashboard>
    </mat-card-content>
  </mat-card>
</aside>
</div>
