<!-- calendar.component.html (replace existing template) -->
<div class="calendar-root">
  <!-- controls toolbar on top (left + right groups) -->
  <div class="calendar-controls">
    <div class="controls-left">
      <button mat-icon-button (click)="prevMonth()" aria-label="Previous month">
        <mat-icon>chevron_left</mat-icon>
      </button>

      <mat-form-field appearance="outline" class="compact-select">
        <mat-select [value]="viewMonth()" (selectionChange)="setMonth($event.value)" disableRipple>
          @for (m of months; track m; let i = $index) {
            <mat-option [value]="i">{{ m }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="compact-select">
        <mat-select [value]="viewYear()" (selectionChange)="setYear($event.value)" disableRipple>
          @for (y of getYears(11); track y) {
            <mat-option [value]="y">{{ y }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <button mat-icon-button (click)="nextMonth()" aria-label="Next month">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <div class="controls-right">
      <mat-button-toggle-group [value]="selectionMode()" (change)="setSelectionMode($event.value)" name="selMode"
        aria-label="Selection mode">
        <mat-button-toggle value="day">Day</mat-button-toggle>
        <mat-button-toggle value="month">Month</mat-button-toggle>
        <mat-button-toggle value="year">Year</mat-button-toggle>
      </mat-button-toggle-group>

      <button mat-stroked-button (click)="openSummary('week')"><mat-icon>calendar_view_week</mat-icon> Week</button>
      <button mat-stroked-button (click)="openSummary('month')"><mat-icon>calendar_view_month</mat-icon> Month</button>
      <button mat-stroked-button (click)="openSummary('year')"><mat-icon>calendar_today</mat-icon> Year</button>

      <button mat-flat-button color="primary" (click)="goToToday()" title="Go to today">
        <mat-icon>today</mat-icon>
        Today
      </button>

      <button mat-icon-button (click)="refreshToday(false)" title="Refresh system date snapshot" [disabled]="isRefreshing()">
        <mat-icon [class.spinning]="isRefreshing()">refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- month title centered below controls -->
  <div class="calendar-header">
    <div class="center-title">{{ getMonthTitle() }}</div>
  </div>

  <div class="weekday-row" role="row">
    @for (w of ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; track w) {
      <div class="weekday">{{ w }}</div>
    }
  </div>

  <div class="days-grid" role="grid">
    @for (d of daysInMonth(); track d; let i = $index) {
      <div class="day-cell" [class.empty]="d === null"
        [class.selected]="daysIso()[i] === selectedDate()" [class.in-selected-month]="isInSelectedMonth(i)"
        [class.in-selected-year]="isInSelectedYear(i)" [class.is-today]="isTodayCell(i)" (click)="onSelectDay(d, i)">
        @if (d !== null) {
          <div class="day-number">{{ d }}</div>
        }
        @if (d !== null) {
          @if (daysIso()[i]; as iso) {
            @if (getCountsForDate(iso).tx > 0 || getCountsForDate(iso).goals > 0) {
              <div class="markers">
                @if (getCountsForDate(iso).tx > 0) {
                  <span class="marker tx">{{ getCountsForDate(iso).tx }}</span>
                }
                @if (getCountsForDate(iso).goals > 0) {
                  <span class="marker goal">G{{ getCountsForDate(iso).goals
                  }}</span>
                }
              </div>
            }
          }
        }
      </div>
    }
  </div>

  <!-- selected date panel -->
  @if (selectedDate(); as sd) {
    <div class="date-panel">
      <h4>{{ sd | date:'fullDate' }}</h4>
      <!-- Date summary -->
      @if (getCountsForDate(sd); as counts) {
        <div class="date-summary">
          @if (counts.tx > 0 || counts.goals > 0) {
            <div class="summary-stats">
              @if (counts.tx > 0) {
                <div class="stat">
                  <mat-icon>sync_alt</mat-icon>
                  <span>{{ counts.tx }} Transaction{{ counts.tx > 1 ? 's' : '' }}</span>
                </div>
              }
              @if (counts.goals > 0) {
                <div class="stat">
                  <mat-icon>flag</mat-icon>
                  <span>{{ counts.goals }} Goal{{ counts.goals > 1 ? 's' : '' }}</span>
                </div>
              }
            </div>
          }
          <!-- Transaction list -->
          @if (counts.txs.length > 0) {
            <div class="items-list">
              <h5>Transactions</h5>
              @for (tx of counts.txs; track tx) {
                <div class="item">
                  <div class="item-type">{{ tx.type | titlecase }}</div>
                  <div class="item-details">
                    <span class="category">{{ tx.categoryName || tx.category || tx.categoryId }}</span>
                    <span class="amount">{{ tx.amount | currency:'PHP' }}</span>
                  </div>
                  @if (tx.note || tx.description) {
                    <div class="item-note">{{ tx.note || tx.description }}</div>
                  }
                </div>
              }
            </div>
          }
          <!-- Goals list -->
          @if (counts.goalsList.length > 0) {
            <div class="items-list">
              <h5>Goals</h5>
              @for (goal of counts.goalsList; track goal) {
                <div class="item">
                  <div class="item-type">{{ goal.title }}</div>
                  <div class="item-details">
                    <span class="target">Target: {{ goal.targetAmount | currency:'PHP' }}</span>
                    <span class="saved">Saved: {{ (goal.currentAmount || goal.savedAmount || 0) | currency:'PHP' }}</span>
                  </div>
                </div>
              }
            </div>
          }
          @if (counts.tx === 0 && counts.goals === 0) {
            <div class="empty-message">
              <p>No transactions or goals for this date</p>
            </div>
          }
        </div>
      }
      <div class="panel-actions">
        <button mat-stroked-button (click)="addTransactionForDate()">
          <mat-icon>add</mat-icon> Add Transaction
        </button>
        <button mat-stroked-button (click)="addGoalForDate()">
          <mat-icon>flag</mat-icon> Add Goal
        </button>
      </div>
    </div>
  }
</div>
